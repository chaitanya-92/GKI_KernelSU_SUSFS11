name: Kernel Build Process

permissions:
  contents: write
  actions: write

on:
  workflow_call:
    inputs:
      android_version:
        required: true
        type: string
      kernel_version:
        required: true
        type: string
      sub_level:
        required: true
        type: string
      os_patch_level:
        required: true
        type: string
      variant:
        required: false
        type: string
      ksu_variant:
        required: true
        type: string
      ksu_commit:
        required: false
        type: string
      build_bypass:
        required: true
        type: boolean

jobs:
  build-gki:
    name: "${{ inputs.kernel_version }}.${{ inputs.sub_level }}-${{ inputs.android_version }}-${{ inputs.os_patch_level }}"
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
    # --------------------------------------------------
    # Summary
    # --------------------------------------------------
    - name: Build Summary
      run: |
        echo "Android Version : ${{ inputs.android_version }}"
        echo "Kernel Version  : ${{ inputs.kernel_version }}"
        echo "Sub Level       : ${{ inputs.sub_level }}"
        echo "Patch Level     : ${{ inputs.os_patch_level }}"
        echo "KSU Variant     : ${{ inputs.ksu_variant }}"

    # --------------------------------------------------
    # Free disk
    # --------------------------------------------------
    - uses: endersonmenezes/free-disk-space@v3
      with:
        remove_android: true
        remove_dotnet: true
        remove_haskell: true
        remove_tool_cache: true
        remove_swap: true

    # --------------------------------------------------
    # Setup env
    # --------------------------------------------------
    - name: Setup Build Environment
      run: |
        CONFIG="${{ inputs.android_version }}-${{ inputs.kernel_version }}-${{ inputs.sub_level }}"
        KERNEL_ROOT="$GITHUB_WORKSPACE/$CONFIG"
        mkdir -p "$KERNEL_ROOT"

        echo "KERNEL_ROOT=$KERNEL_ROOT" >> $GITHUB_ENV
        echo "DEFCONFIG=$KERNEL_ROOT/common/arch/arm64/configs/gki_defconfig" >> $GITHUB_ENV
        echo "ANYKERNEL3=$GITHUB_WORKSPACE/AnyKernel3" >> $GITHUB_ENV
        echo "SUSFS4KSU=$GITHUB_WORKSPACE/susfs4ksu" >> $GITHUB_ENV

        mkdir -p git-repo
        curl -L https://storage.googleapis.com/git-repo-downloads/repo -o git-repo/repo
        chmod +x git-repo/repo
        echo "$GITHUB_WORKSPACE/git-repo" >> $GITHUB_PATH

    # --------------------------------------------------
    # Clone tools
    # --------------------------------------------------
    - name: Clone AnyKernel3
      run: |
        git clone https://github.com/WildKernels/AnyKernel3.git -b gki-2.0
        rm -rf AnyKernel3/.git

    # --------------------------------------------------
    # Kernel source
    # --------------------------------------------------
    - name: Sync Kernel Source
      working-directory: ${{ env.KERNEL_ROOT }}
      run: |
        BRANCH="common-${{ inputs.android_version }}-${{ inputs.kernel_version }}-${{ inputs.os_patch_level }}"
        repo init -u https://android.googlesource.com/kernel/manifest -b "$BRANCH" --depth=1
        repo sync -c -j$(nproc) --force-sync --no-tags

    # --------------------------------------------------
    # KernelSU
    # --------------------------------------------------
    - name: Apply KernelSU
      working-directory: ${{ env.KERNEL_ROOT }}
      run: |
        case "${{ inputs.ksu_variant }}" in
          WKSU)
            curl -LSs https://raw.githubusercontent.com/WildKernels/Wild_KSU/wild/kernel/setup.sh | bash -s wild
            ;;
          KSU)
            curl -LSs https://raw.githubusercontent.com/tiann/KernelSU/main/kernel/setup.sh | bash -s main
            ;;
        esac

    # --------------------------------------------------
    # SUSFS (CLEAN, ONCE)
    # --------------------------------------------------
    - name: Apply SUSFS
      working-directory: ${{ env.KERNEL_ROOT }}
      run: |
        git clone https://gitlab.com/simonpunk/susfs4ksu.git -b gki-${{ inputs.android_version }}-${{ inputs.kernel_version }}

        cd common
        mkdir -p include/linux
        cp ../susfs4ksu/kernel_patches/include/linux/susfs.h include/linux/
        cp ../susfs4ksu/kernel_patches/fs/* fs/

        PATCH="50_add_susfs_in_gki-${{ inputs.android_version }}-${{ inputs.kernel_version }}.patch"
        if [ -f "../susfs4ksu/kernel_patches/$PATCH" ]; then
          patch -p1 < "../susfs4ksu/kernel_patches/$PATCH"
        fi

    # --------------------------------------------------
    # Kernel version fix
    # --------------------------------------------------
    - name: Fix Kernel Version
      working-directory: ${{ env.KERNEL_ROOT }}
      run: |
        sed -i 's/CONFIG_LOCALVERSION_AUTO=y/CONFIG_LOCALVERSION_AUTO=n/' $DEFCONFIG || true
        echo 'CONFIG_LOCALVERSION="-Os3-g80a"' >> $DEFCONFIG
        sed -i 's/-dirty//g' common/scripts/setlocalversion
        sed -i 's/-maybe-dirty//g' build/kernel/kleaf/impl/stamp.bzl || true

    # --------------------------------------------------
    # Build
    # --------------------------------------------------
    - name: Build Kernel
      working-directory: ${{ env.KERNEL_ROOT }}
      run: |
        if [ -f build/build.sh ]; then
          BUILD_CONFIG=common/build.config.gki.aarch64 build/build.sh
        else
          tools/bazel build //common:kernel_aarch64_dist
        fi

    # --------------------------------------------------
    # AnyKernel3
    # --------------------------------------------------
    - name: Prepare AnyKernel3
      run: |
        cp $KERNEL_ROOT/bazel-bin/common/kernel_aarch64/Image $ANYKERNEL3/Image

    # --------------------------------------------------
    # Upload
    # --------------------------------------------------
    - uses: actions/upload-artifact@v4
      with:
        name: kernel-${{ inputs.kernel_version }}-${{ inputs.android_version }}-AnyKernel3
        path: AnyKernel3/**
