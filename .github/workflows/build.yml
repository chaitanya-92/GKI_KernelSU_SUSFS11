name: Kernel Build Process

on:
  workflow_call:
    inputs:
      android_version:
        required: true
        type: string
      kernel_version:
        required: true
        type: string
      sub_level:
        required: true
        type: string
      os_patch_level:
        required: true
        type: string
      ksu_variant:
        required: true
        type: string
      ksu_commit:
        required: false
        type: string
      build_bypass:
        required: true
        type: boolean

jobs:
  build-gki:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      # --------------------------------------------------
      # SUMMARY
      # --------------------------------------------------
      - name: Build Summary
        run: |
          echo "Android  : ${{ inputs.android_version }}"
          echo "Kernel   : ${{ inputs.kernel_version }}"
          echo "Sublevel : ${{ inputs.sub_level }}"
          echo "Patch    : ${{ inputs.os_patch_level }}"
          echo "KSU      : ${{ inputs.ksu_variant }}"

      # --------------------------------------------------
      # ENV SETUP
      # --------------------------------------------------
      - name: Setup environment
        run: |
          CONFIG="${{ inputs.android_version }}-${{ inputs.kernel_version }}-${{ inputs.sub_level }}"
          echo "CONFIG=$CONFIG" >> $GITHUB_ENV
          echo "KERNEL_ROOT=$GITHUB_WORKSPACE/$CONFIG" >> $GITHUB_ENV
          echo "ANYKERNEL3=$GITHUB_WORKSPACE/AnyKernel3" >> $GITHUB_ENV
          echo "DEFCONFIG=$GITHUB_WORKSPACE/$CONFIG/common/arch/arm64/configs/gki_defconfig" >> $GITHUB_ENV
          mkdir -p "$GITHUB_WORKSPACE/$CONFIG"

      # --------------------------------------------------
      # REPO TOOL
      # --------------------------------------------------
      - name: Install repo
        run: |
          mkdir -p ~/bin
          curl https://storage.googleapis.com/git-repo-downloads/repo > ~/bin/repo
          chmod +x ~/bin/repo
          echo "$HOME/bin" >> $GITHUB_PATH

      # --------------------------------------------------
      # SYNC KERNEL
      # --------------------------------------------------
      - name: Sync kernel source
        working-directory: ${{ env.KERNEL_ROOT }}
        run: |
          BRANCH="${{ inputs.android_version }}-${{ inputs.kernel_version }}-${{ inputs.os_patch_level }}"
          repo init -u https://android.googlesource.com/kernel/manifest -b common-$BRANCH --depth=1
          repo sync -c -j$(nproc) --no-tags --force-sync

      # --------------------------------------------------
      # ANYKERNEL3
      # --------------------------------------------------
      - name: Clone AnyKernel3
        run: |
          git clone https://github.com/WildKernels/AnyKernel3.git -b gki-2.0
          rm -rf AnyKernel3/.git

      # --------------------------------------------------
      # KERNELSU (FIXED)
      # --------------------------------------------------
      - name: Install KernelSU
        working-directory: ${{ env.KERNEL_ROOT }}
        run: |
          case "${{ inputs.ksu_variant }}" in
            WKSU)
              curl -LSs https://raw.githubusercontent.com/WildKernels/Wild_KSU/wild/kernel/setup.sh | bash -s wild
              ;;
            KSU)
              curl -LSs https://raw.githubusercontent.com/tiann/KernelSU/main/kernel/setup.sh | bash -s main
              ;;
            Next)
              curl -LSs https://raw.githubusercontent.com/KernelSU-Next/KernelSU-Next/dev/kernel/setup.sh | bash -s dev
              ;;
          esac

      # --------------------------------------------------
      # LOCALVERSION (Os3)
      # --------------------------------------------------
      - name: Set kernel localversion
        working-directory: ${{ env.KERNEL_ROOT }}
        run: |
          sed -i '/CONFIG_LOCALVERSION/d' $DEFCONFIG
          sed -i '/CONFIG_LOCALVERSION_AUTO/d' $DEFCONFIG
          echo 'CONFIG_LOCALVERSION="-Os3"' >> $DEFCONFIG
          echo 'CONFIG_LOCALVERSION_AUTO=y' >> $DEFCONFIG
          grep LOCALVERSION $DEFCONFIG

      # --------------------------------------------------
      # REMOVE maybe-dirty
      # --------------------------------------------------
      - name: Disable dirty tag
        working-directory: ${{ env.KERNEL_ROOT }}/common
        run: |
          sed -i 's/maybe-dirty//g' scripts/setlocalversion
          sed -i 's/-dirty//g' scripts/setlocalversion

      # --------------------------------------------------
      # BUILD
      # --------------------------------------------------
      - name: Build kernel
        working-directory: ${{ env.KERNEL_ROOT }}
        run: |
          set -e
          LTO=thin BUILD_CONFIG=common/build.config.gki.aarch64 build/build.sh

      # --------------------------------------------------
      # PACKAGE
      # --------------------------------------------------
      - name: Package AnyKernel3
        run: |
          cp $KERNEL_ROOT/out/*/dist/Image AnyKernel3/Image

      # --------------------------------------------------
      # UPLOAD
      # --------------------------------------------------
      - name: Upload kernel
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.kernel_version }}.${{ inputs.sub_level }}-${{ inputs.android_version }}-${{ inputs.os_patch_level }}-AnyKernel3
          path: AnyKernel3/**
