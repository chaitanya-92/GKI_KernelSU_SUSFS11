name: Kernel Build Process

on:
  workflow_call:
    inputs:
      android_version:
        required: true
        type: string
      kernel_version:
        required: true
        type: string
      sub_level:
        required: true
        type: string
      os_patch_level:
        required: true
        type: string
      ksu_variant:
        required: true
        type: string
      build_bypass:
        required: true
        type: boolean

jobs:
  build-gki:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    name: "${{ inputs.kernel_version }}.${{ inputs.sub_level }}-${{ inputs.android_version }}-${{ inputs.os_patch_level }}-${{ inputs.ksu_variant }}"

    steps:
    # -------------------------------------------------
    # SETUP ENV
    # -------------------------------------------------
    - name: Setup Build Environment
      run: |
        CONFIG="${{ inputs.android_version }}-${{ inputs.kernel_version }}-${{ inputs.sub_level }}"
        KERNEL_ROOT="$GITHUB_WORKSPACE/$CONFIG"

        mkdir -p "$KERNEL_ROOT"

        echo "CONFIG=$CONFIG" >> $GITHUB_ENV
        echo "KERNEL_ROOT=$KERNEL_ROOT" >> $GITHUB_ENV
        echo "DEFCONFIG=$KERNEL_ROOT/common/arch/arm64/configs/gki_defconfig" >> $GITHUB_ENV
        echo "ANYKERNEL3=$GITHUB_WORKSPACE/AnyKernel3" >> $GITHUB_ENV

        mkdir -p $GITHUB_WORKSPACE/git-repo
        curl -L https://storage.googleapis.com/git-repo-downloads/repo -o $GITHUB_WORKSPACE/git-repo/repo
        chmod +x $GITHUB_WORKSPACE/git-repo/repo
        echo "$GITHUB_WORKSPACE/git-repo" >> $GITHUB_PATH

    # -------------------------------------------------
    # CLONE AnyKernel3
    # -------------------------------------------------
    - name: Clone AnyKernel3
      run: |
        git clone https://github.com/WildKernels/AnyKernel3.git -b gki-2.0
        rm -rf AnyKernel3/.git

    # -------------------------------------------------
    # SYNC KERNEL SOURCE
    # -------------------------------------------------
    - name: Init & Sync Kernel Source
      working-directory: ${{ env.KERNEL_ROOT }}
      run: |
        BRANCH="common-${{ inputs.android_version }}-${{ inputs.kernel_version }}-${{ inputs.os_patch_level }}"
        repo init -u https://android.googlesource.com/kernel/manifest -b "$BRANCH" --depth=1
        repo sync -c -j$(nproc) --no-tags --force-sync

    # -------------------------------------------------
    # ADD KernelSU
    # -------------------------------------------------
    - name: Add KernelSU
      working-directory: ${{ env.KERNEL_ROOT }}
      run: |
        case "${{ inputs.ksu_variant }}" in
          WKSU)
            curl -LSs https://raw.githubusercontent.com/WildKernels/Wild_KSU/wild/kernel/setup.sh | bash -s wild
            ;;
          KSU)
            curl -LSs https://raw.githubusercontent.com/tiann/KernelSU/main/kernel/setup.sh | bash -s main
            ;;
        esac

    # -------------------------------------------------
    # CONFIGURE DEFCONFIG
    # -------------------------------------------------
    - name: Configure Kernel
      working-directory: ${{ env.KERNEL_ROOT }}
      run: |
        cat >> "$DEFCONFIG" << 'EOF'
        CONFIG_KSU=y
        CONFIG_TMPFS_XATTR=y
        CONFIG_TMPFS_POSIX_ACL=y

        # Custom OS version
        CONFIG_LOCALVERSION="-Os3"
        CONFIG_LOCALVERSION_AUTO=y
        EOF

        grep LOCALVERSION "$DEFCONFIG"

    # -------------------------------------------------
    # BUILD KERNEL (FIXED)
    # -------------------------------------------------
    - name: Build Kernel
      working-directory: ${{ env.KERNEL_ROOT }}
      run: |
        set -e

        if [ -f "build/build.sh" ]; then
          echo "Using legacy build.sh"
          LTO=thin BUILD_CONFIG=common/build.config.gki.aarch64 build/build.sh
        else
          echo "Using Bazel build (android15 / 6.6+)"
          tools/bazel build \
            --config=fast \
            --lto=thin \
            //common:kernel_aarch64_dist
        fi

    # -------------------------------------------------
    # COPY IMAGE TO AnyKernel3
    # -------------------------------------------------
    - name: Prepare AnyKernel3
      run: |
        if [ -f "$KERNEL_ROOT/bazel-bin/common/kernel_aarch64/Image" ]; then
          cp "$KERNEL_ROOT/bazel-bin/common/kernel_aarch64/Image" "$ANYKERNEL3/Image"
        elif [ -f "$KERNEL_ROOT/out/${{ inputs.android_version }}-${{ inputs.kernel_version }}/dist/Image" ]; then
          cp "$KERNEL_ROOT/out/${{ inputs.android_version }}-${{ inputs.kernel_version }}/dist/Image" "$ANYKERNEL3/Image"
        else
          echo "Image not found!"
          exit 1
        fi

    # -------------------------------------------------
    # UPLOAD ARTIFACT
    # -------------------------------------------------
    - name: Upload AnyKernel3
      uses: actions/upload-artifact@v4
      with:
        name: ${{ inputs.kernel_version }}.${{ inputs.sub_level }}-${{ inputs.android_version }}-${{ inputs.os_patch_level }}-AnyKernel3
        path: AnyKernel3/**
        compression-level: 9
