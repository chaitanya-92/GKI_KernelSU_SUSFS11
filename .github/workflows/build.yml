name: Kernel Build Process

permissions:
  contents: write
  actions: write

on:
  workflow_call:
    inputs:
      android_version:
        required: true
        type: string
      kernel_version:
        required: true
        type: string
      sub_level:
        required: true
        type: string
      os_patch_level:
        required: true
        type: string
      variant:
        required: false
        type: string
      ksu_variant:
        required: true
        type: string
      ksu_commit:
        required: false
        type: string
      build_bypass:
        required: true
        type: boolean

jobs:
  build-gki:
    name: "${{ inputs.kernel_version }}.${{ inputs.sub_level }}-${{ inputs.android_version }}-${{ inputs.os_patch_level }}-${{ matrix.build_type }}-${{ inputs.ksu_variant }}"
    runs-on: ubuntu-latest
    timeout-minutes: 60

    strategy:
      fail-fast: false
      matrix:
        build_type: >-
          ${{
            fromJSON(
              inputs.variant == 'vTomsonek' && '["vTomsonek"]' ||
              inputs.variant == 'TheWildJames' && '["TheWildJames"]' ||
              inputs.variant == 'MarionKernel' && '["MarionKernel"]' ||
              inputs.variant == 'Hakan' && '["Hakan"]' ||
              (inputs.build_bypass && '["Normal","Bypass"]' || '["Normal"]')
            )
          }}

    steps:
    - name: Build Summary
      run: |
        echo "========================================"
        echo " Kernel Build Summary"
        echo "========================================"
        echo "Android Version : ${{ inputs.android_version }}"
        echo "Kernel Version  : ${{ inputs.kernel_version }}"
        echo "Sub Level       : ${{ inputs.sub_level }}"
        echo "Patch Level     : ${{ inputs.os_patch_level }}"
        echo "Build Type      : ${{ matrix.build_type }}"
        echo "KSU Variant     : ${{ inputs.ksu_variant }}"
        echo "========================================"

    - name: Free Disk Space
      uses: endersonmenezes/free-disk-space@v3
      with:
        remove_android: true
        remove_dotnet: true
        remove_haskell: true
        remove_tool_cache: true
        remove_swap: true

    - name: Setup Build Environment
      run: |
        CONFIG="${{ inputs.android_version }}-${{ inputs.kernel_version }}-${{ inputs.sub_level }}"
        KERNEL_ROOT="$GITHUB_WORKSPACE/$CONFIG"
        mkdir -p "$KERNEL_ROOT"

        echo "DEFCONFIG=$KERNEL_ROOT/common/arch/arm64/configs/gki_defconfig" >> $GITHUB_ENV
        echo "KERNEL_ROOT=$KERNEL_ROOT" >> $GITHUB_ENV
        echo "SUSFS4KSU=$GITHUB_WORKSPACE/susfs4ksu" >> $GITHUB_ENV
        echo "KERNEL_PATCHES=$GITHUB_WORKSPACE/kernel_patches" >> $GITHUB_ENV
        echo "ANYKERNEL3=$GITHUB_WORKSPACE/AnyKernel3" >> $GITHUB_ENV

        mkdir -p git-repo
        curl -L https://storage.googleapis.com/git-repo-downloads/repo -o git-repo/repo
        chmod +x git-repo/repo
        echo "$GITHUB_WORKSPACE/git-repo" >> $GITHUB_PATH

    - name: Clone Dependencies
      run: |
        git clone https://github.com/WildKernels/AnyKernel3.git -b gki-2.0
        rm -rf AnyKernel3/.git
        git clone https://github.com/WildKernels/kernel_patches.git

    - name: Init & Sync Kernel
      working-directory: ${{ env.KERNEL_ROOT }}
      run: |
        BRANCH="common-${{ inputs.android_version }}-${{ inputs.kernel_version }}-${{ inputs.os_patch_level }}"
        repo init -u https://android.googlesource.com/kernel/manifest -b "$BRANCH" --depth=1
        repo sync -c -j$(nproc) --force-sync --no-tags

    - name: Clone SUSFS
      run: |
        git clone https://gitlab.com/simonpunk/susfs4ksu.git \
          -b gki-${{ inputs.android_version }}-${{ inputs.kernel_version }}

    - name: Apply SUSFS Kernel Patches
      working-directory: ${{ env.KERNEL_ROOT }}/common
      run: |
        cp -r "$SUSFS4KSU/kernel_patches/fs/"* fs/
        cp -r "$SUSFS4KSU/kernel_patches/include/linux/"* include/linux/
        patch -p1 < "$SUSFS4KSU/kernel_patches/50_add_susfs_in_gki-${{ inputs.android_version }}-${{ inputs.kernel_version }}.patch" || true

    # ðŸ”´ MANDATORY STEP (FIXES YOUR ERROR)
    - name: Install SUSFS headers
      working-directory: ${{ env.KERNEL_ROOT }}
      run: |
        echo "Installing SUSFS headers..."
        mkdir -p common/include/linux
        cp -v "$SUSFS4KSU/kernel_patches/include/linux/susfs.h" common/include/linux/
        ls -l common/include/linux/susfs.h

    # âœ… KernelSU AFTER headers
    - name: Add KernelSU Variant
      working-directory: ${{ env.KERNEL_ROOT }}
      run: |
        case "${{ inputs.ksu_variant }}" in
          WKSU)
            curl -LSs https://raw.githubusercontent.com/WildKernels/Wild_KSU/wild/kernel/setup.sh | bash -s wild
            ;;
          Next)
            curl -LSs https://raw.githubusercontent.com/KernelSU-Next/KernelSU-Next/dev/kernel/setup.sh | bash -s dev
            ;;
          KSU)
            curl -LSs https://raw.githubusercontent.com/tiann/KernelSU/main/kernel/setup.sh | bash -s main
            ;;
          RKSU)
            curl -LSs https://raw.githubusercontent.com/rsuntk/KernelSU/main/kernel/setup.sh | bash -s main
            ;;
        esac

    - name: Configure Kernel
      working-directory: ${{ env.KERNEL_ROOT }}
      run: |
        cat >> "$DEFCONFIG" << EOF
        CONFIG_KSU=y
        CONFIG_KSU_SUSFS=y
        CONFIG_TMPFS_XATTR=y
        CONFIG_TMPFS_POSIX_ACL=y
        EOF

    - name: Build Kernel
      working-directory: ${{ env.KERNEL_ROOT }}
      run: |
        if [ -f build/build.sh ]; then
          BUILD_CONFIG=common/build.config.gki.aarch64 build/build.sh
        else
          tools/bazel build //common:kernel_aarch64_dist
        fi

    - name: Prepare AnyKernel3
      run: |
        cp "$KERNEL_ROOT"/out/*/dist/Image "$ANYKERNEL3/Image" || \
        cp "$KERNEL_ROOT"/bazel-bin/common/kernel_aarch64/Image "$ANYKERNEL3/Image"

    - name: Upload AnyKernel3
      uses: actions/upload-artifact@v4
      with:
        name: Kernel-${{ inputs.android_version }}-${{ inputs.kernel_version }}
        path: AnyKernel3/**
